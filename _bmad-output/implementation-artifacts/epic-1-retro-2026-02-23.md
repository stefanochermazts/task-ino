# Epic 1 Retrospective: Finite Daily Planning Loop

**Date:** 2026-02-23  
**Epic:** 1 – Finite Daily Planning Loop  
**Status:** Completed  
**Participants:** Stefano (Project Lead), Bob (Scrum Master), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer)

---

## Epic Summary

**Epic 1** delivers the complete `Inbox -> Finite Today -> Explicit Closure` loop in local-first mode, with deterministic Today computation and hard invariant enforcement.

### Delivery Metrics

| Metric | Value |
|--------|-------|
| Completed Stories | 8/8 (100%) |
| Total Stories | 8 |
| Blockers Encountered | 0 |
| Technical Debt Items | 0 (documented) |
| Test Coverage | 97 JS tests (Vitest), PHPUnit feature tests |

### Stories Delivered

- **1.1** Capture Tasks in Inbox (Online/Offline)
- **1.2** Deterministic Today Projection from Local State
- **1.3** Add to Today with Cap Enforcement
- **1.4** Configure Personal Today Cap
- **1.5** Invariant-Safe Single and Bulk Mutations
- **1.6** Explicit End-of-Day Closure Flow
- **1.7** Daily Plan Review Before Execution
- **1.8** Local Persistence and Rebuild After Reload

### FRs Covered

FR1, FR2, FR3, FR4, FR5, FR6, FR7, FR8, FR9, FR17, FR18, FR19, FR20

---

## Deep Story Analysis – Patterns Extracted

### Common Struggles (2+ stories)

1. **Error feedback placement** – Multiple stories initially routed errors to `#quick-capture-feedback` instead of panel-specific elements (`#closure-error`, `#review-error`, `#today-cap-feedback`). Code reviews consistently caught this.
2. **Error visibility** – Elements with `hidden` class were not toggled when showing errors; text was set but elements remained invisible.
3. **Focus management** – Panel openings (closure, review) lacked explicit focus on primary controls; added in code reviews.
4. **Async handling** – `showClosurePanel` initially did not await `updateClosurePanel()`; `.catch()` paths were missing for async panel updates.
5. **Validation before mutation** – Persistence functions (`removeTaskFromToday`, `setTaskPaused`) needed precondition checks (e.g. `todayIncluded === true`) to avoid invalid state transitions.

### Recurring Code Review Feedback

- **Error handling:** Dedicated error elements per panel; toggle `hidden` when showing/clearing errors.
- **Test coverage:** Integration tests for error paths; assert visibility, not just text content.
- **Async flows:** Proper `async/await` and `.catch()`; route errors to panel-scoped feedback.
- **Validation:** Precondition checks before persistence writes; return explicit domain codes.
- **DRY:** Avoid duplicate logic (e.g. `isValidTaskRecord` vs `isRenderableTask`).

### Breakthrough Moments

1. **`mutationGuardrail` as single write-path** – Story 1.5 established the pattern; Stories 1.6 (closure) and future mutations extend it cleanly.
2. **Over-cap panel pattern** – Story 1.3’s guided decision UI was reused for closure panel (1.6) and review panel (1.7).
3. **Vitest + happy-dom** – Story 1.5 switched from jsdom for Node 18 ESM compatibility; baseline stable for all subsequent stories.
4. **`refreshInbox()` as canonical refresh** – Story 1.8 solidified this; closure and review flows reuse it consistently.

### Velocity Patterns

- First stories (1.1–1.4) required more code-review remediation.
- Stories 1.5–1.8 benefited from established patterns; implementation was faster, but code reviews still surfaced error-handling and UX gaps.
- Adversarial code review proved valuable; multiple stories needed two review cycles (e.g. 1.6).

---

## Successes

1. **Local-first loop delivered** – Inbox capture, Today projection, cap enforcement, closure, and review flow work offline-first with IndexedDB.
2. **Invariant layer solid** – `mutatePlanningState` is the single write-path; all mutations route through it.
3. **Deterministic projection** – `computeTodayProjection` is pure and testable; rebuild after reload is deterministic.
4. **Test suite growth** – 97 JS tests; integration tests cover error paths, visibility, and read-only flows.
5. **Non-punitive UX** – Copy and feedback align with UX spec (guided, choice-oriented, no blame-framing).

---

## Challenges

1. **Error feedback consistency** – Initial implementations often used the wrong feedback element; checklist for “which element for which flow” would help.
2. **Visibility vs. content** – Tests and code sometimes asserted text but not visibility (`hidden` class); both matter.
3. **Mock sequencing in tests** – `listInboxTasks` mock sequences had to be tuned (e.g. for review-panel error test) to ensure the right call failed.
4. **Story documentation drift** – Story 1.6 tasks referenced `#quick-capture-feedback` for defer/pause errors after code used `#closure-error`; docs were updated in second review.

---

## Key Insights

1. **Panel-scoped error elements** – Each modal/panel (over-cap, closure, review) should have its own error element; avoid routing to global feedback.
2. **Visibility assertions in tests** – When testing error display, assert both `textContent` and `classList.contains('hidden')`.
3. **Focus on open** – When a panel opens, set focus to the primary action (first decision button or confirm button).
4. **Precondition validation in persistence** – Store functions should validate preconditions (e.g. task in Today) before mutating; return explicit domain codes.
5. **Code review as quality gate** – Adversarial review consistently caught error-handling, async, and UX gaps; keep it as a mandatory step.

---

## Previous Retrospective Follow-Through

This is the first retrospective; no previous action items to track.

---

## Next Epic Preview: Epic 2 – Task Organization and Scheduling Continuity

**Objective:** Enable users to organize, move, reprioritize, and reschedule tasks across areas and time contexts while preserving planning integrity.

**Stories:** 2.1 (Area-Based Organization), 2.2 (Cross-Area Today), 2.3 (Single-Item Move), 2.4 (Single-Item Reschedule), 2.5 (Bulk Reschedule), 2.6 (Daily Cycle Continuity)

**Dependencies on Epic 1:**
- Deterministic Today projection (`computeTodayProjection`)
- Invariant layer (`mutatePlanningState`)
- Persistence contracts (`inboxTaskStore`, `todayCapStore`)
- Projection refresh pattern (`refreshInbox`)

**Preparation Needed:**
- Area-based structure (new domain concept)
- Today cross-area aggregation logic
- Temporal context for reschedule
- No new infrastructure; Epic 1 provides solid base.

---

## Action Items

| # | Action | Owner | Success Criteria |
|---|--------|-------|-------------------|
| 1 | Add checklist for panel error elements: over-cap → `#today-cap-feedback`, closure → `#closure-error`, review → `#review-error` | Dev | Documented in project-context or dev notes |
| 2 | When adding new panels, include dedicated error element + visibility toggling from day one | Dev | No code-review findings for error placement |
| 3 | Include focus management in panel-open flows by default | Dev | New panels set focus on primary control |
| 4 | In integration tests for error display, assert both text and `hidden` class state | Dev | Error-path tests check visibility |

---

## Epic 2 Preparation Tasks

| # | Task | Owner | Notes |
|---|------|-------|------|
| 1 | Review Epic 2 story definitions for area/temporal concepts | SM | Ensure alignment with Epic 1 projection contracts |
| 2 | Verify `inboxTaskStore` and projection layer can support `area` field | Dev | May need schema extension for areas |
| 3 | Confirm `mutatePlanningState` extension pattern for new actions | Dev | Follow 1.5/1.6 pattern |

---

## Critical Path

- No blockers identified.
- Epic 1 is complete; all stories done, tests green.
- Ready to begin Epic 2 when preparation tasks are addressed.

---

## Readiness Assessment

| Dimension | Status |
|-----------|--------|
| Testing & Quality | ✅ 97 tests passing; error paths covered |
| Deployment | N/A (local dev) |
| Stakeholder Acceptance | N/A |
| Technical Health | ✅ Codebase stable; invariant layer solid |
| Unresolved Blockers | None |

---

## Commitments and Next Steps

1. Execute action items before/during Epic 2.
2. Use error-element checklist when implementing new panels.
3. Run full test suite before marking stories done.
4. Begin Epic 2 with `create-story` for 2.1 when ready.

---

*Retrospective completed 2026-02-23. Epic 1 retrospective marked done in sprint-status.*
